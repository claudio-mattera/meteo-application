<!DOCTYPE html>
<html>
    <head>
        <title>Chart</title>
        <meta charset="utf-8">
            <link href='./metricsgraphics.css' rel='stylesheet' type='text/css'>
            <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
            <script src="https://code.highcharts.com/highcharts.js"></script>
            <script src="https://code.highcharts.com/modules/exporting.js"></script>
        </head>
    <body>
        <div id="chart"></div>

        <form action="javascript:plot();">
            <div>
                <label for="start">Start:</label>
                <input type="datetime" id="start" value="2016-05-20 19:50:00">
            </div>
            <div>
                <label for="end">End:</label>
                <input type="datetime" id="end" value="2016-05-20 23:00:00">
            </div>
            <div>
                <label for="streams">Streams:</label>
                <select id="streams" multiple size="10"></select>
            </div>
            <div>
            <button type="submit">Plot</button>
            </div>
        </form>

        <script type="text/javascript">
function getSelectedValues(select) {
    var result = [];

    for (let option of select.options) {
        if (option.selected) {
            result.push(option.value);
        }
    }

    return result;
}

function fetch_available_streams() {
    uri = "./get_available_streams"
    console.log("URI: " + uri)
    $.getJSON(uri, function(data) {
        streams = data["streams"];

        for (let stream of streams) {
            console.log(stream);

            var select = document.getElementById('streams');
            var option = document.createElement('option');
            option.value = stream['name'];
            option.innerHTML = stream['name'] + " (" + stream['kind'] + ")";
            select.appendChild(option);
        }
    });
}

function plot() {
    start = document.getElementById("start").value;
    end = document.getElementById("end").value;
    meters = getSelectedValues(document.getElementById("streams"));

    uri = "./get_stream?start=" + start + "&end=" + end + "&meters=" + meters
    console.log("URI: " + uri)
    $.getJSON(uri, function(data) {

        kindToIndex = {
            'temperature': 0,
            'pressure': 1,
            'humidity': 2,
            'light': 3,
            'presence': 4,
            'altitude': 5,
        }

        series = [];

        data = data["data"];

        for (var key in data) {
            if (data.hasOwnProperty(key) && !data[key]["metadata"]["hide"]) {
                console.log(data[key]["metadata"]["name"]);
                series.push({
                    type: 'spline',
                    data: data[key]["readings"],
                    name: key,
                    yAxis: kindToIndex[data[key]["metadata"]["kind"]]
                });
            }
        }

        temperature_axis = {
            labels: {
                format: '{value}Â°C',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            title: {
                text: 'Temperature',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            opposite: false
        }
        pressure_axis = {
            labels: {
                format: '{value} Pa',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            title: {
                text: 'Pressure',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            opposite: true
        }
        humidity_axis = {
            labels: {
                format: '{value} %',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            title: {
                text: 'Humidity',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            opposite: true
        }
        light_axis = {
            labels: {
                format: '{value} Lx',
                style: {
                    color: Highcharts.getOptions().colors[3]
                }
            },
            title: {
                text: 'Light',
                style: {
                    color: Highcharts.getOptions().colors[3]
                }
            },
            opposite: true
        }
        presence_axis = {
            labels: {
                format: '{value}',
                style: {
                    color: Highcharts.getOptions().colors[4]
                }
            },
            title: {
                text: 'Presence',
                style: {
                    color: Highcharts.getOptions().colors[4]
                }
            },
            opposite: true
        }
        altitude_axis = {
            labels: {
                format: '{value} m',
                style: {
                    color: Highcharts.getOptions().colors[4]
                }
            },
            title: {
                text: 'Altitude',
                style: {
                    color: Highcharts.getOptions().colors[4]
                }
            },
            opposite: true
        }
        yAxis = [
            temperature_axis,
            pressure_axis,
            humidity_axis,
            light_axis,
            presence_axis,
            altitude_axis
        ]

        $('#chart').highcharts({
            chart: {
                zoomType: 'x'
            },
            rangeSelector : {
                selected : 1
            },

            title : {
                text : 'Weather data'
            },
            xAxis: {
                type: 'datetime'
            },
            yAxis: yAxis,
            plotOptions: {
                spline: {
                    marker: {
                        radius: 0
                    }
                }
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                x: 80,
                verticalAlign: 'top',
                y: 55,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
            },
            series : series
        });
    }).fail(function() {
        console.log("Error loading JSON");
    });
}

document.onload = fetch_available_streams();
        </script>
    </body>
</html>
